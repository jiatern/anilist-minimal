<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniList Simplified Frontend</title>
    <script src="https://cdn.tailwindcss.com"></script>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=block" rel="stylesheet">
    <style>
        body { background-color: #2b2b2b; color: #e2e2e2; font-family: Ubuntu; }
        .item-row { animation: slideInUp 0.3s ease-out; }
        .item-row:hover { background-color: rgba(255, 255, 255, 0.05); cursor: pointer; }
        .thumb-square { width: 48px; height: 48px; object-fit: cover; object-position: center; border-radius: 4px; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; opacity: 1 !important; }
        .loading-spinner { border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid #3b82f6; border-radius: 50%; width: 14px; height: 14px; animation: spin 0.8s linear infinite; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Animations */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .loading-indicator { animation: fadeIn 0.3s ease-out; }
        #search-modal.active { animation: fadeIn 0.2s ease-out; }
        #search-modal > div { animation: slideInUp 0.3s ease-out; }
        #edit-modal.active { animation: fadeIn 0.2s ease-out; }
        #edit-modal > div { animation: slideInUp 0.3s ease-out; }
        
        /* Mobile optimizations */
        @media (max-width: 767px) {
            #edit-modal > div {
                flex-direction: column;
                max-height: 90vh;
            }
            .edit-poster-container {
                height: 180px;
                width: 100%;
            }
        }
        
        #search-modal.closing { animation: fadeOut 0.2s ease-out forwards; }
        #search-modal.closing > div { animation: slideDown 0.3s ease-out forwards; }
        #edit-modal.closing { animation: fadeOut 0.2s ease-out forwards; }
        #edit-modal.closing > div { animation: slideDown 0.3s ease-out forwards; }
        
        @keyframes slideDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
        
        .search-result-item { animation: slideIn 0.3s ease-out; }
        .search-result-item:nth-child(2) { animation-delay: 0.05s; }
        .search-result-item:nth-child(3) { animation-delay: 0.1s; }
        .search-result-item:nth-child(4) { animation-delay: 0.15s; }
        .search-result-item:nth-child(5) { animation-delay: 0.2s; }
        
        #sync-btn.pulse { animation: pulse 0.6s ease-in-out; }
        
        /* Success message */
        #success-message { animation: slideInUp 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div id="login-screen" class="hidden flex items-center justify-center min-h-screen px-4">
        <div class="bg-[#1f1f1f] p-8 rounded-xl border border-white/10 w-full max-w-md shadow-2xl">
            <h1 class="text-2xl font-bold mb-2">Login</h1>
            <p class="text-sm opacity-50 mb-6">Enter your AniList Access Token.</p>
            <input type="password" id="token-input" placeholder="Paste token..." class="w-full bg-[#2b2b2b] border border-white/10 rounded px-4 py-3 mb-4 focus:border-blue-500 outline-none">
            <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-bold transition">Login</button>
        </div>
    </div>

    <div id="app-screen" class="hidden max-w-4xl mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-xl font-bold opacity-90">My Anime List</h1>
                <div id="display-user" class="text-xs opacity-40 uppercase tracking-widest mt-1"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="handleLogout()" class="text-[10px] opacity-30 hover:opacity-100 uppercase mr-4">Logout</button>
                <button onclick="forceRefresh()" id="sync-btn" title="Refresh & Clear Cache" class="p-2 hover:bg-white/5 rounded-lg opacity-60"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg></button>
                <button onclick="toggleModal('search-modal', true)" class="bg-blue-600 px-4 py-2 rounded-lg text-sm font-bold">+ Add</button>
            </div>
        </header>

        <nav class="flex gap-6 border-b border-white/5 mb-2 overflow-x-auto">
            <button onclick="switchTab('CURRENT')" id="tab-CURRENT" class="pb-3 text-sm opacity-50 tab-active whitespace-nowrap">Watching <span id="count-CURRENT" class="text-xs opacity-40">(0)</span></button>
            <button onclick="switchTab('COMPLETED')" id="tab-COMPLETED" class="pb-3 text-sm opacity-50 whitespace-nowrap">Completed <span id="count-COMPLETED" class="text-xs opacity-40">(0)</span></button>
            <button onclick="switchTab('PLANNING')" id="tab-PLANNING" class="pb-3 text-sm opacity-50 whitespace-nowrap">Planning <span id="count-PLANNING" class="text-xs opacity-40">(0)</span></button>
            <button onclick="switchTab('DROPPED')" id="tab-DROPPED" class="pb-3 text-sm opacity-50 whitespace-nowrap">Dropped <span id="count-DROPPED" class="text-xs opacity-40">(0)</span></button>
            <button onclick="switchTab('PAUSED')" id="tab-PAUSED" class="pb-3 text-sm opacity-50 whitespace-nowrap">On Hold <span id="count-PAUSED" class="text-xs opacity-40">(0)</span></button>
        </nav>

        <div id="loading-indicator" class="hidden flex items-center gap-2 text-xs opacity-50 mb-4">
            <div class="loading-spinner"></div> <span id="loading-text">Loading...</span>
        </div>

        <div id="success-message" class="hidden fixed top-4 right-4 bg-green-600/90 text-white px-4 py-3 rounded-lg text-sm font-medium shadow-lg">
            ✓ Sync complete
        </div>

        <div id="list-container" class="flex flex-col"></div>
    </div>

    <div id="search-modal" onclick="handleOutsideClick(event)" class="fixed inset-0 bg-black/85 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] w-full max-w-lg rounded-xl overflow-hidden border border-white/5 shadow-2xl">
            <div class="p-4 border-b border-white/5 flex justify-between">
                <span class="text-xs font-bold uppercase opacity-50">Search Anime</span>
                <button onclick="toggleModal('search-modal', false)" class="opacity-50 text-xl px-2">&times;</button>
            </div>
            <div class="p-4">
                <input type="text" id="search-in" placeholder="Search..." class="w-full bg-[#2b2b2b] p-3 rounded border border-white/10 outline-none focus:border-blue-500 mb-4 text-sm">
                <div id="search-results" class="space-y-1 max-h-60 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <div id="add-status-modal" onclick="handleOutsideClick(event)" class="fixed inset-0 bg-black/85 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] w-full max-w-sm rounded-xl overflow-hidden border border-white/5 shadow-2xl">
            <div class="p-4 border-b border-white/5 flex justify-between">
                <span class="text-xs font-bold uppercase opacity-50">Add to List</span>
                <button onclick="toggleModal('add-status-modal', false)" class="opacity-50 text-xl px-2">&times;</button>
            </div>
            <div class="p-4 space-y-2">
                <button onclick="addAnimeWithStatus('CURRENT')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 text-sm transition-colors">Watching</button>
                <button onclick="addAnimeWithStatus('COMPLETED')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 text-sm transition-colors">Completed</button>
                <button onclick="addAnimeWithStatus('PLANNING')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 text-sm transition-colors">Planning</button>
                <button onclick="addAnimeWithStatus('DROPPED')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 text-sm transition-colors">Dropped</button>
                <button onclick="addAnimeWithStatus('PAUSED')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 text-sm transition-colors">On Hold</button>
                <button onclick="addAnimeWithStatus('REPEATING')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 text-sm transition-colors">Rewatching</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" onclick="handleOutsideClick(event)" class="fixed inset-0 bg-black/85 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] w-full max-w-2xl rounded-xl overflow-hidden border border-white/5 shadow-2xl flex flex-col md:flex-row max-h-[90vh] md:max-h-none">
            <div class="edit-poster-container w-full md:w-72 flex-shrink-0 bg-black/20 md:max-h-none">
                <img id="edit-poster" src="" class="w-full h-full object-cover">
            </div>
            
            <div class="flex-1 p-6 flex flex-col justify-between">
                <div>
                    <div class="flex justify-between items-start mb-6">
                        <h3 id="edit-title" class="font-bold text-xl leading-tight pr-4">Title</h3>
                        <button onclick="toggleModal('edit-modal', false)" class="opacity-50 text-2xl leading-none">&times;</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] uppercase opacity-40 font-bold block mb-1 tracking-wider">Status</label>
                                <select id="edit-status-select" class="w-full bg-[#2b2b2b] border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 transition-colors h-10">
                                    <option value="CURRENT">Watching</option>
                                    <option value="PLANNING">Planning</option>
                                    <option value="COMPLETED">Completed</option>
                                    <option value="DROPPED">Dropped</option>
                                    <option value="PAUSED">On Hold</option>
                                    <option value="REPEATING">Rewatching</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase opacity-40 font-bold block mb-1 tracking-wider">Progress</label>
                                <div class="flex items-center bg-[#2b2b2b] border border-white/10 rounded-lg px-3 py-2">
                                    <input type="number" id="edit-progress-input" class="w-full bg-transparent text-sm outline-none text-blue-400 font-bold" min="0">
                                    <span class="text-xs opacity-40 mx-1">/</span>
                                    <span id="edit-total-ep" class="text-xs opacity-40">?</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] uppercase opacity-40 font-bold block mb-1 tracking-wider">Score</label>
                                <input type="number" id="edit-score-input" class="w-full bg-[#2b2b2b] border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-blue-400 font-bold" min="0" max="10" step="0.1" placeholder="0-10">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase opacity-40 font-bold block mb-1 tracking-wider">Rewatches</label>
                                <input type="number" id="edit-repeat-input" class="w-full bg-[#2b2b2b] border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-blue-400 font-bold" min="0" placeholder="0">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] uppercase opacity-40 font-bold block mb-1 tracking-wider">Start Date</label>
                                <input type="date" id="edit-start-date-input" class="w-full bg-[#2b2b2b] border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-blue-400">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase opacity-40 font-bold block mb-1 tracking-wider">Finish Date</label>
                                <input type="date" id="edit-finish-date-input" class="w-full bg-[#2b2b2b] border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500 text-blue-400">
                            </div>
                        </div>

                        <a id="edit-anilist-link" href="#" target="_blank" class="flex items-center justify-center gap-2 text-blue-400 text-xs py-2.5 border border-blue-400/20 rounded-lg hover:bg-blue-400/10 transition-all font-medium">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                            View on AniList
                        </a>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="save-edit-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-3.5 rounded-xl font-bold text-sm transition-all shadow-lg active:scale-[0.98]">
                        Save Changes
                    </button>
                    <button id="delete-entry-btn" class="w-full border border-red-500/50 text-red-500 hover:bg-red-500/10 py-2 rounded-lg text-xs font-bold transition mt-2">
                        Delete from List
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://graphql.anilist.co';
        const CACHE_EXPIRY = 1000 * 60 * 240; 
        const CACHE_KEY = `cache_v4_full_list`; // Bumped key
        let currentTab = 'CURRENT';
        let username = "";
        let pendingAnimeToAdd = null;

        function checkAuth() {
            const token = localStorage.getItem('anilist_token');
            if (!token) {
                document.getElementById('login-screen').classList.remove('hidden');
            } else {
                document.getElementById('app-screen').classList.remove('hidden');
                initApp();
            }
        }

        function handleLogin() {
            const val = document.getElementById('token-input').value;
            if (val) { localStorage.setItem('anilist_token', val); location.reload(); }
        }

        function handleLogout() { localStorage.clear(); location.reload(); }

        async function initApp() {
            try {
                // Check if we have cached username
                let cachedUsername = localStorage.getItem('anilist_username');
                if (!cachedUsername) {
                    // Only fetch if not cached
                    const data = await gql(`query { Viewer { name } }`);
                    cachedUsername = data.Viewer.name;
                    localStorage.setItem('anilist_username', cachedUsername);
                }
                username = cachedUsername;
                document.getElementById('display-user').innerText = `@${username}`;
                loadData();
            } catch (e) { handleLogout(); }
        }

        async function gql(query, vars = {}) {
            const token = localStorage.getItem('anilist_token');
            const res = await fetch(API, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, variables: vars })
            });
            const json = await res.json();
            if (json.errors) throw new Error(json.errors[0].message);
            return json.data;
        }

        async function loadData(force = false, skipClear = false) {
            let cached = null;
            try {
                const cachedStr = localStorage.getItem(CACHE_KEY);
                cached = cachedStr ? JSON.parse(cachedStr) : null;
            } catch (e) {
                console.error('Cache parse error:', e);
                cached = null;
            }
            
            const now = Date.now();
            const container = document.getElementById('list-container');
            const isCacheValid = cached && cached.data && cached.time && (now - cached.time <= CACHE_EXPIRY);
            
            if (force || !isCacheValid) {
                if (!skipClear) {
                    container.innerHTML = '';
                    document.getElementById('loading-indicator').classList.remove('hidden');
                }
                try {
                    const res = await gql(`
                        query ($name: String) {
                            MediaListCollection(userName: $name, type: ANIME) {
                                lists { entries { id status progress score startedAt { year month day } completedAt { year month day } repeat media { id title { romaji } episodes coverImage { extraLarge large medium } siteUrl } } }
                            }
                        }`, { name: username });
                    
                    const allEntries = (res.MediaListCollection.lists || []).flatMap(l => l.entries || []);
                    cached = { time: now, data: allEntries };
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cached));
                } catch (e) { 
                    console.error(e);
                    if (!skipClear) {
                        container.innerHTML = `<p class="opacity-40 py-10 text-center text-xs">Error: ${e.message}</p>`;
                    }
                    document.getElementById('loading-indicator').classList.add('hidden');
                    return;
                }
            }
            if (cached && cached.data) {
                renderFilteredList(cached.data);
            }
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        function renderFilteredList(data, skipAnimation = false) {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            const filteredEntries = data.filter(e => {
                if (currentTab === 'CURRENT') return e.status === 'CURRENT' || e.status === 'REPEATING';
                return e.status === currentTab;
            });
            filteredEntries.sort((a, b) => a.media.title.romaji.localeCompare(b.media.title.romaji));
            updateTabCounts(data);
            renderList(filteredEntries, skipAnimation);
        }

        function updateTabCounts(data) {
            const counts = {};
            data.forEach(e => {
                if (e.status === 'CURRENT' || e.status === 'REPEATING') {
                    counts['CURRENT'] = (counts['CURRENT'] || 0) + 1;
                } else {
                    counts[e.status] = (counts[e.status] || 0) + 1;
                }
            });
            ['CURRENT', 'PLANNING', 'COMPLETED', 'DROPPED', 'PAUSED'].forEach(tab => {
                const countEl = document.getElementById(`count-${tab}`);
                if (countEl) countEl.innerText = `(${counts[tab] || 0})`;
            });
        }

        async function addAnimeWithStatus(status) {
            if (!pendingAnimeToAdd) return;
            
            const anime = pendingAnimeToAdd;
            toggleModal('add-status-modal', false);
            
            // Show success immediately (optimistic UI)
            const successMsg = document.getElementById('success-message');
            successMsg.innerText = `✓ Added to ${getStatusLabel(status)}`;
            successMsg.classList.remove('hidden');
            setTimeout(() => {
                successMsg.classList.add('hidden');
            }, 3000);
            
            // Update cache optimistically before API call
            const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
            if (cached && cached.data) {
                const newEntry = {
                    id: anime.id,
                    status: status,
                    progress: 0,
                    media: {
                        id: anime.id,
                        title: { romaji: anime.title.romaji },
                        episodes: anime.episodes,
                        coverImage: anime.coverImage,
                        siteUrl: anime.siteUrl
                    }
                };
                cached.data.push(newEntry);
                localStorage.setItem(CACHE_KEY, JSON.stringify(cached));
                renderFilteredList(cached.data);
            }
            
            // Make API call in background
            try {
                await gql(`mutation($m:Int, $s:MediaListStatus){SaveMediaListEntry(mediaId:$m, status:$s){id}}`, { 
                    m: anime.id, 
                    s: status 
                });
            } catch (e) {
                console.error(e);
                alert('Error adding anime: ' + e.message);
            }
            pendingAnimeToAdd = null;
        }
        
        function getStatusLabel(status) {
            const labels = {
                'CURRENT': 'Watching',
                'PLANNING': 'Planning',
                'COMPLETED': 'Completed',
                'DROPPED': 'Dropped',
                'PAUSED': 'On Hold',
                'REPEATING': 'Rewatching'
            };
            return labels[status] || status;
        }

        function forceRefresh() {
            const syncBtn = document.getElementById('sync-btn');
            syncBtn.classList.add('animate-spin');
            
            // Show cached data immediately while syncing
            const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
            if (cached) {
                renderFilteredList(cached.data);
            } else {
                document.getElementById('loading-indicator').classList.remove('hidden');
            }
            
            // Load fresh data in background without clearing the screen
            loadData(true, true).finally(() => {
                setTimeout(() => syncBtn.classList.remove('animate-spin'), 500);
                // Show success message
                const successMsg = document.getElementById('success-message');
                successMsg.classList.remove('hidden');
                setTimeout(() => {
                    successMsg.classList.add('hidden');
                }, 3000);
            });
        }

        function renderList(entries, skipAnimation = false) {
            const container = document.getElementById('list-container');
            container.innerHTML = entries.length ? '' : '<p class="opacity-20 py-10 text-center text-xs italic">No entries in this list</p>';
            const showScore = currentTab === 'COMPLETED' || currentTab === 'DROPPED';
            entries.forEach(e => {
                const row = document.createElement('div');
                row.id = `row-item-${e.id}`;
                row.className = "item-row flex items-center py-0.5 transition-colors group";
                if (skipAnimation) {
                    row.style.animation = 'none';
                }
                row.onclick = (event) => { if(event.target.tagName !== 'BUTTON') openEditModal(e); };
                row.innerHTML = `
                    <img src="${e.media.coverImage.medium}" class="thumb-square bg-gray-800" loading="lazy">
                    <div class="flex-1 px-4 text-sm font-normal truncate opacity-90">${e.media.title.romaji}</div>
                    <div class="flex items-center gap-6 pr-2">
                        <div class="flex items-center gap-1 text-sm">
                            <span id="prog-${e.id}" class="font-medium text-base text-blue-400 w-6 text-right">${e.progress}</span>
                            <button onclick="event.stopPropagation(); updateProg(${e.id}, ${e.progress}, this)" 
                                    class="text-base opacity-0 group-hover:opacity-100 transition-opacity duration-200 cursor-pointer hover:text-blue-400">+</button>
                            <span class="text-base font-normal opacity-60">/</span>
                            <span class="text-base font-normal opacity-60 ml-3 w-6">${e.media.episodes || '?'}</span>
                        </div>
                        ${showScore ? `<div class="text-sm opacity-100 ml-3 w-6 text-right">${e.score ? e.score.toFixed(1) : '-'}</div>` : ''}
                    </div>`;
                container.appendChild(row);
            });
        }

        function openEditModal(entry) {
            // Get latest entry data from cache to reflect any recent changes
            const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
            const cachedEntry = cached && cached.data ? cached.data.find(x => x.id === entry.id) : entry;
            const latestEntry = cachedEntry || entry;
            
            // Get the best available image: try large, then extraLarge, then medium
            let posterUrl = latestEntry.media.coverImage.large || latestEntry.media.coverImage.extraLarge || latestEntry.media.coverImage.medium;
            
            // If we ended up with medium, try to upgrade to large by URL replacement
            if (posterUrl && posterUrl.includes('/medium/')) {
                posterUrl = posterUrl.replace('/medium/', '/large/');
            }
            
            document.getElementById('edit-poster').src = posterUrl; 
            document.getElementById('edit-title').innerText = latestEntry.media.title.romaji;
            document.getElementById('edit-status-select').value = latestEntry.status;
            document.getElementById('edit-progress-input').value = latestEntry.progress;
            document.getElementById('edit-score-input').value = latestEntry.score || '';
            document.getElementById('edit-repeat-input').value = latestEntry.repeat || 0;
            document.getElementById('edit-total-ep').innerText = latestEntry.media.episodes || '?';
            document.getElementById('edit-anilist-link').href = latestEntry.media.siteUrl;
            
            // Set dates - convert from year/month/day format to YYYY-MM-DD
            if (latestEntry.startedAt && latestEntry.startedAt.year) {
                const startDate = new Date(latestEntry.startedAt.year, (latestEntry.startedAt.month || 1) - 1, (latestEntry.startedAt.day || 1));
                document.getElementById('edit-start-date-input').value = startDate.toISOString().split('T')[0];
            } else {
                document.getElementById('edit-start-date-input').value = '';
            }
            if (latestEntry.completedAt && latestEntry.completedAt.year) {
                const endDate = new Date(latestEntry.completedAt.year, (latestEntry.completedAt.month || 1) - 1, (latestEntry.completedAt.day || 1));
                document.getElementById('edit-finish-date-input').value = endDate.toISOString().split('T')[0];
            } else {
                document.getElementById('edit-finish-date-input').value = '';
            }
            
            const saveBtn = document.getElementById('save-edit-btn');
            saveBtn.onclick = async () => {
                const newStatus = document.getElementById('edit-status-select').value;
                const newProgress = parseInt(document.getElementById('edit-progress-input').value);
                const scoreVal = document.getElementById('edit-score-input').value;
                const newScore = scoreVal ? parseFloat(scoreVal) : null;
                
                // Validate score
                if (newScore !== null && newScore > 10) {
                    alert('Score cannot be greater than 10.');
                    return;
                }
                
                const newRepeat = parseInt(document.getElementById('edit-repeat-input').value) || 0;
                
                // Convert dates to AniList format (YYYYMMDD)
                let startDate = null, endDate = null;
                const startDateVal = document.getElementById('edit-start-date-input').value;
                const endDateVal = document.getElementById('edit-finish-date-input').value;
                if (startDateVal) {
                    const sd = new Date(startDateVal);
                    startDate = { year: sd.getFullYear(), month: sd.getMonth() + 1, day: sd.getDate() };
                }
                if (endDateVal) {
                    const ed = new Date(endDateVal);
                    endDate = { year: ed.getFullYear(), month: ed.getMonth() + 1, day: ed.getDate() };
                }
                
                saveBtn.disabled = true;
                saveBtn.innerText = "Saving...";
                
                // Update cache optimistically
                const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
                if (cached) {
                    const idx = cached.data.findIndex(x => x.id === entry.id);
                    if (idx !== -1) {
                        cached.data[idx].status = newStatus;
                        cached.data[idx].progress = newProgress;
                        if (newScore !== null) cached.data[idx].score = newScore;
                        cached.data[idx].repeat = newRepeat;
                        if (startDate) cached.data[idx].startedAt = startDate;
                        if (endDate) cached.data[idx].completedAt = endDate;
                        localStorage.setItem(CACHE_KEY, JSON.stringify(cached));
                        renderFilteredList(cached.data, true);
                    }
                }
                toggleModal('edit-modal', false);
                
                // Show success message
                const successMsg = document.getElementById('success-message');
                successMsg.innerText = '✓ Changes saved';
                successMsg.classList.remove('hidden');
                setTimeout(() => {
                    successMsg.classList.add('hidden');
                }, 3000);
                
                // Make API call in background
                try {
                    const mutationVars = { id: entry.id, status: newStatus, progress: newProgress, repeat: newRepeat };
                    let query = `mutation ($id: Int, $status: MediaListStatus, $progress: Int, $repeat: Int`;
                    let returnFields = `id status progress repeat`;
                    
                    if (newScore !== null) {
                        mutationVars.score = newScore;
                        query += `, $score: Float`;
                        returnFields += ` score`;
                    }
                    if (startDate) {
                        mutationVars.startDate = startDate;
                        query += `, $startDate: FuzzyDateInput`;
                        returnFields += ` startedAt { year month day }`;
                    }
                    if (endDate) {
                        mutationVars.completedDate = endDate;
                        query += `, $completedDate: FuzzyDateInput`;
                        returnFields += ` completedAt { year month day }`;
                    }
                    
                    query += `) { SaveMediaListEntry(id: $id, status: $status, progress: $progress`;
                    if (newScore !== null) query += `, score: $score`;
                    if (startDate) query += `, startedAt: $startDate`;
                    if (endDate) query += `, completedAt: $completedDate`;
                    query += `, repeat: $repeat) { ${returnFields} } }`;
                    
                    await gql(query, mutationVars);
                } catch (e) {
                    console.error(e);
                    alert('Error saving changes: ' + e.message);
                }
                saveBtn.disabled = false;
                saveBtn.innerText = "Save Changes";
            };

            const deleteBtn = document.getElementById('delete-entry-btn');
            deleteBtn.onclick = async () => {
                if (!confirm(`Are you sure you want to delete ${entry.media.title.romaji} from your list?`)) return;
        
                toggleModal('edit-modal', false);
                
                // Show success immediately (optimistic UI)
                const successMsg = document.getElementById('success-message');
                successMsg.innerText = '✓ Deleted from list';
                successMsg.classList.remove('hidden');
                setTimeout(() => {
                    successMsg.classList.add('hidden');
                }, 3000);
                
                // Remove from cache optimistically
                const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
                if (cached) {
                    cached.data = cached.data.filter(x => x.id !== entry.id);
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cached));
                    renderFilteredList(cached.data);
                }
        
                // Call API in background
                try {
                    await gql(`mutation ($id: Int) { DeleteMediaListEntry(id: $id) { deleted } }`, { id: entry.id });
                } catch (e) {
                    console.error(e);
                    alert("Error deleting: " + e.message);
                }
            };

            toggleModal('edit-modal', true);
        }

        async function updateProg(id, cur, btn) {
            const newCount = cur + 1;
            btn.disabled = true;
            btn.classList.add('opacity-20');
            
            // Update cache and render optimistically without animation
            const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
            if (cached) {
                const idx = cached.data.findIndex(x => x.id === id);
                if (idx !== -1) {
                    cached.data[idx].progress = newCount;
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cached));
                    renderFilteredList(cached.data, true);
                }
            }
            
            // Call API in background
            try {
                await gql(`mutation ($id: Int, $progress: Int) { SaveMediaListEntry(id: $id, progress: $progress) { id progress } }`, { id, progress: newCount });
            } catch (e) { 
                alert(e.message);
                // Revert on error
                document.getElementById(`prog-${id}`).innerText = cur;
                btn.onclick = (e) => { e.stopPropagation(); updateProg(id, cur, btn); };
                if (cached) {
                    const idx = cached.data.findIndex(x => x.id === id);
                    if (idx !== -1) {
                        cached.data[idx].progress = cur;
                        localStorage.setItem(CACHE_KEY, JSON.stringify(cached));
                    }
                }
            }
            btn.disabled = false;
            btn.classList.remove('opacity-20');
        }

        function switchTab(status) {
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            const activeBtn = document.getElementById(`tab-${status}`);
            if (activeBtn) activeBtn.classList.add('tab-active');
            currentTab = status;
            loadData();
        }

        document.getElementById('search-in').addEventListener('input', debounce(async (e) => {
            if (e.target.value.length < 3) return;
            const res = await gql(`query($s:String){Page(perPage:5){media(search:$s,type:ANIME){id title{romaji}coverImage{medium large extraLarge}siteUrl episodes}}}`, { s: e.target.value });
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = '';
            res.Page.media.forEach(m => {
                const b = document.createElement('button');
                b.className = "search-result-item w-full flex items-center gap-3 p-2 hover:bg-white/5 rounded text-left text-xs";
                // Even search uses high res URLs now
                let sUrl = m.coverImage.medium;
                if (sUrl.includes('/medium/')) sUrl = sUrl.replace('/medium/', '/large/');
                
                b.innerHTML = `<img src="${sUrl}" class="w-8 h-8 object-cover rounded"> ${m.title.romaji}`;
                b.onclick = async () => {
                    pendingAnimeToAdd = m;
                    toggleModal('search-modal', false);
                    toggleModal('add-status-modal', true);
                };
                resDiv.appendChild(b);
            });
        }, 850));

        function handleOutsideClick(e) {
            if (e.target.id === 'search-modal' || e.target.id === 'edit-modal') {
                toggleModal(e.target.id, false);
            }
        }

        function toggleModal(id, s) { 
            const m = document.getElementById(id);
            if (s) {
                // Opening modal
                m.classList.remove('hidden');
                m.classList.remove('closing');
                m.classList.add('active');
            } else {
                // Closing modal with fade-out animation
                m.classList.remove('active');
                m.classList.add('closing');
                setTimeout(() => {
                    m.classList.add('hidden');
                    m.classList.remove('closing');
                }, 300);
            }
            if (!s && id === 'search-modal') {
                document.getElementById('search-in').value = '';
                document.getElementById('search-results').innerHTML = '';
            }
        }
        function debounce(f, t) { let i; return (...a) => { clearTimeout(i); i = setTimeout(() => f(...a), t); }; }

        checkAuth();
    </script>
</body>
</html>
